$(document).ready(function(){var resize_on,mixedMode={name:"htmlmixed",scriptTypes:[{matches:/\/x-handlebars-template|\/x-mustache/i,mode:null},{matches:/(text|application)\/(x-)?vb(a|script)/i,mode:"vbscript"}]};window.editor=CodeMirror.fromTextArea(document.getElementById("template"),{mode:mixedMode,selectionPointer:true,styleActiveLine:true,autoCloseBrackets:true,matchBrackets:true,indentWithTabs:!editor_prefs.indent_with_space,smartIndent:true,lineNumbers:true,matchBrackets:true,autofocus:true,indentUnit:2,keyMap:editor_prefs.keymap,gutters:["CodeMirror-linenumbers","CodeMirror-foldgutter"],fold:"indent",foldGutter:{rangeFinder:new CodeMirror.fold.combine(CodeMirror.fold.indent,CodeMirror.fold.comment)},extraKeys:{"Ctrl-Space":"autocomplete","Shift-Tab":"indentLess","Ctrl-Q":function(cm){cm.foldCode(cm.getCursor())},Tab:"indentMore",Esc:function(cm){if(cm.getOption("fullScreen"))cm.setOption("fullScreen",false)},"Ctrl-S":function(cm){save_template(0)},"Cmd-S":function(cm){save_template(0)}},theme:editor_prefs.theme});resize_codemirror(0);window.buffers={};buffers["0"]=editor_tab_init();buffers["1"]=editor_tab_init();buffers["2"]=editor_tab_init();resize_on=true;$(window).resize(function(){if(resize_on){resize_codemirror(1)}});$(document).on("click","#search",function(e){if(e.shiftKey){CodeMirror.commands["replace"](editor)}else{CodeMirror.commands["find"](editor)}});$(document).on("click","#word_wrap",function(){window.editor.setOption("lineWrapping",!window.editor.getOption("lineWrapping"))});$(document).on("click","#fullscreen",function(){window.editor.setOption("fullScreen",!window.editor.getOption("fullScreen"))});$(document).on("click","#newtemplate",function(){$("#template_id").val("");$("#template_name").val("");template_set_tab_content("","","");$("#template_name").focus()});if(jQuery().tablesorter){$("table.sortable").tablesorter({widgets:["zebra"]})}$("#preview").click(function(){template_show_in_window()});$("#cancel").click(function(){if(confirm(mydbr_loc["MYDBR_AA_DISCARD"])){$("#template_id").val("");$("#template_name").val("");template_set_tab_content("","","");template_clear_edited("template")}});template_drag_drop();$(document).on("change","#template_folders",function(){$("#template_folder_id").val($(this).val());template_list_get()});$(document).on("click","#tab_browsing_list div.tab",function(){editor_tab_select($(this).closest("li"))});$(document).on("click","#newfolder",function(){jPrompt("","",mydbr_loc["MYDBR_TEMPLATE_ADD_FOLDER"],new_template_folder)});$(document).on("dblclick",".template_in_list.folder, .template_in_list.folder_up",function(event){if(event.altKey){var id,name;id=$(this).parent().attr("data-id");name=$(this).parents(".row").children().first().text();template_folder_rename_p(id,name)}else{$("#template_folder_id").val($(this).parent().attr("data-id"));template_list_get()}});$(document).on("click",".template_in_list.template",function(){$(this).closest(".rows").children().removeClass("selected");$(this).parent().addClass("selected");template_get("template",$(this).parent().attr("data-id"),$(this).text())});$(document).on("click",".folder.i_delete",function(){var t=$(this).parents(".row").children().first();if(confirm("Delete folder '"+t.text()+"'?")){template_del(t.parent().attr("data-id"),"folder")}});$(document).on("click",".template.i_delete",function(){var t=$(this).parents(".row").children().first();if(confirm(sprintf(mydbr_loc["MYDBR_TEMPLATE_DELETE"],t.text()))){template_del(t.parent().attr("data-id"),"template")}});$("#save").click(function(){save_template(0)});$("#save_close").click(function(){save_template(1)})});function template_folder_rename_p(id,name){window.template_rename_id=id;jPrompt("",name,mydbr_loc["MYDBR_FOLDER_NAME"],template_folder_rename)}function new_template_folder(text){var parent_id=$("#template_folder_id").val();$.ajax({url:"apps_v/template_folder_action.php",type:"post",data:{id:parent_id,name:text,action:"new",csrf_token:csrf_token_get()},success:function(data){template_list_get()}})}function template_folder_rename(text){$.ajax({url:"apps_v/template_folder_action.php",type:"post",data:{id:window.template_rename_id,name:text,action:"rename",csrf_token:csrf_token_get()},success:function(data){template_list_get()}})}function template_drag_drop(){$(".row.template,.row.folder").draggable({containment:"#templatelist",opacity:.5,revert:true,revertDuration:0});$(".row.folder,.row.folder_up").droppable({hoverClass:"drop_highlite",drop:function(event,ui){var id=ui.draggable.attr("data-id"),target=$(this).attr("data-id"),type=ui.draggable.hasClass("template")?"template":"folder";$.ajax({url:"apps_v/template_to_folder.php",type:"post",data:{id:id,target:target,type:type,csrf_token:csrf_token_get()},success:function(data){template_list_get()}})}})}function template_clear_edited(obj_id){}function template_set_tab_content(header,row,footer){var t,cur_tab;header=header===null?"":header;row=row===null?"":row;footer=footer===null?"":footer;editor_tab_set_text(0,header);editor_tab_set_text(1,row);editor_tab_set_text(2,footer);cur_tab=$("#tab_browsing_list li.selected").attr("data-id");switch(cur_tab){case"0":t=header;break;case"1":t=row;break;case"2":t=footer;break}editor.setValue(t)}function template_del(id,type){$.ajax({url:"apps_v/template_del.php",type:"post",data:{id:id,csrf_token:csrf_token_get(),type:type},success:function(data){template_list_get()}})}function template_get(obj_id,id,name){$.ajax({url:"apps_v/template_get.php",type:"get",data:{id:id},dataType:"json",success:function(data){if(data.length==3){$("#template_id").val(id);$("#template_name").val(name);template_set_tab_content(data[0],data[1],data[2]);debugger;var tab_id,sel=parseInt($("#tab_browsing_area li.selected").attr("data-id"),10);if(data[sel]==""||data[sel]===null){if(data[0]!==""&&data[0]!==null){tab_id=0}else if(data[1]!==""&&data[1]!==null){tab_id=1}else{tab_id=2}editor_tab_select($("#tab_browsing_area").find("li[data-id='"+tab_id+"']"))}template_clear_edited(obj_id)}else{if(data.length==1){alert(data[0])}}}})}function template_show_in_window(){var path,template_window,title=$("#template_name").val();if(!template_window||!template_window.open){path=location.href.substring(0,location.href.lastIndexOf("/")+1);template_window=window.open("",title,"");template_window.document.write("<html><head><title>"+title+"</title>");template_window.document.write('<link rel="stylesheet" type="text/css" href="'+path+'interface/style.css">');template_window.document.write('<link rel="stylesheet" type="text/css" href="'+path+'interface/normal.css">');template_window.document.write('</head><body><div class="content template">');template_window.document.write(editor_tab_get_text(0));template_window.document.write(editor_tab_get_text(1));template_window.document.write(editor_tab_get_text(2));template_window.document.write("</div></body></html>")}}function save_template(close_it){var id,name,header,row,footer;template_id="template";id=$("#template_id").val();name=$.trim($("#template_name").val());if(name==""){alert(mydbr_loc["MYDBR_AA_MISSING_NAME"]);return}header=editor_tab_get_text(0);row=editor_tab_get_text(1);footer=editor_tab_get_text(2);$.ajax({url:"apps_v/template_save.php",type:"post",data:{id:id,name:name,header:header,row:row,footer:footer,folder_id:$("#template_folder_id").val(),csrf_token:csrf_token_get()},success:function(data){var timeout;if(data=="1"){timeout=700;$.blockUI.defaults.growlCSS.width="auto";$.blockUI.defaults.growlCSS.left="10px";$.blockUI.defaults.growlCSS.top="37px";$.blockUI.defaults.growlCSS.right="";$.blockUI.defaults.growlCSS.opacity=1;$.blockUI.defaults.growlCSS.backgroundColor="#00C42E";$.growlUI(null,mydbr_loc["MYDBR_TEMPLATE_SAVED"],timeout);if(close_it){$("#template_id").val("");$("#template_name").val("");template_set_tab_content("","","");template_clear_edited(template_id)}template_list_get()}if(data=="0"){timeout=1500;$.blockUI.defaults.growlCSS.width="auto";$.blockUI.defaults.growlCSS.left="10px";$.blockUI.defaults.growlCSS.right="";$.blockUI.defaults.growlCSS.opacity=.9;$.blockUI.defaults.growlCSS.backgroundColor="red";$.growlUI(null,mydbr_loc["MYDBR_TEMPLATE_SAVE_DUPLICATE"],timeout)}}})}function template_list_get(){$.ajax({url:"apps_v/template_list_get.php",type:"get",data:{id:$("#template_folder_id").val()},success:function(data){$("#templatelist").html(data);template_drag_drop()}})}